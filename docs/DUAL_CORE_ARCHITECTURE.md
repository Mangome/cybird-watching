# CybirdWatching åŒæ ¸æ¶æ„è¯´æ˜

## æ¦‚è¿°

CybirdWatching v3.0 é‡‡ç”¨åŒæ ¸æ¶æ„ï¼Œå……åˆ†å‘æŒ¥ ESP32 åŒæ ¸å¤„ç†å™¨çš„æ€§èƒ½ä¼˜åŠ¿ï¼Œå°† UI æ¸²æŸ“å’Œç³»ç»Ÿé€»è¾‘åˆ†ç¦»åˆ°ä¸åŒçš„æ ¸å¿ƒä¸Šè¿è¡Œã€‚

## æ¶æ„è®¾è®¡

### Core 0 - Protocol Core (UIä»»åŠ¡)
**ä¼˜å…ˆçº§**: 2 (é«˜)  
**æ ˆå¤§å°**: 8KB  
**åˆ·æ–°ç‡**: 200Hz (5mså‘¨æœŸ)

**èŒè´£**:
- âœ¨ LVGL GUIç³»ç»Ÿæ›´æ–° (`lv_timer_handler()`)
- ğŸ–¥ï¸ Displayé©±åŠ¨åˆ·æ–° (`screen.routine()`)
- ğŸ¦ Bird AnimationåŠ¨ç”»æ’­æ”¾
- ğŸ¨ å›¾ç‰‡è§£ç å’Œæ¸²æŸ“

**ä¼˜åŠ¿**:
- ä¸“ç”¨æ ¸å¿ƒä¿è¯UIæµç•…åº¦
- ä¸å—ä¼ æ„Ÿå™¨è¯»å–é˜»å¡
- ç¨³å®šçš„å¸§ç‡è¾“å‡º

---

### Core 1 - Application Core (ç³»ç»Ÿä»»åŠ¡)
**ä¼˜å…ˆçº§**: 1 (æ­£å¸¸)  
**æ ˆå¤§å°**: 8KB  
**åˆ·æ–°ç‡**: 100Hz (10mså‘¨æœŸ)

**èŒè´£**:
- ğŸ“¡ IMUä¼ æ„Ÿå™¨æ•°æ®æ›´æ–° (200msé—´éš”)
- âŒ¨ï¸ ä¸²å£å‘½ä»¤å¤„ç†
- ğŸŒ WiFiç½‘ç»œé€šä¿¡
- ğŸ’¾ SDå¡æ–‡ä»¶æ“ä½œ
- ğŸ¯ BirdManagerä¸šåŠ¡é€»è¾‘
- ğŸ“Š ç»Ÿè®¡æ•°æ®ç®¡ç†

**ä¼˜åŠ¿**:
- é«˜é¢‘ä»»åŠ¡ä¸å¹²æ‰°UIæ¸²æŸ“
- ç‹¬ç«‹å¤„ç†IOå¯†é›†å‹æ“ä½œ
- æå‡ç³»ç»Ÿå“åº”é€Ÿåº¦

---

## ä»»åŠ¡é—´é€šä¿¡

### æ¶ˆæ¯é˜Ÿåˆ—
- **UI Queue**: å®¹é‡10ï¼Œç”¨äºå‘UIä»»åŠ¡å‘é€æ¶ˆæ¯
- **System Queue**: å®¹é‡20ï¼Œç”¨äºå‘ç³»ç»Ÿä»»åŠ¡å‘é€æ¶ˆæ¯

### LVGLäº’æ–¥é”
ç”±äºLVGLä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œæ‰€æœ‰è®¿é—®LVGLå¯¹è±¡çš„æ“ä½œéƒ½å¿…é¡»å…ˆè·å–äº’æ–¥é”ï¼š

```cpp
TaskManager* taskMgr = TaskManager::getInstance();

// è·å–é”
if (taskMgr->takeLVGLMutex(100)) {
    // å®‰å…¨åœ°è®¿é—®LVGLå¯¹è±¡
    lv_obj_set_pos(obj, x, y);
    
    // é‡Šæ”¾é”
    taskMgr->giveLVGLMutex();
}
```

---

## æ€§èƒ½ä¼˜åŒ–

### ä»»åŠ¡ä¼˜å…ˆçº§ç­–ç•¥
- UIä»»åŠ¡ä¼˜å…ˆçº§æ›´é«˜(2)ï¼Œç¡®ä¿ç•Œé¢æµç•…
- ç³»ç»Ÿä»»åŠ¡ä¼˜å…ˆçº§æ­£å¸¸(1)ï¼Œå¤„ç†åå°é€»è¾‘

### åˆ·æ–°ç‡è®¾è®¡
- UIä»»åŠ¡: 200Hz - ä¿è¯LVGLæµç•…æ¸²æŸ“
- ç³»ç»Ÿä»»åŠ¡: 100Hz - å¹³è¡¡å“åº”é€Ÿåº¦å’ŒCPUå ç”¨
- IMUæ›´æ–°: 5Hz - å‡å°‘ä¼ æ„Ÿå™¨è¯»å–å¼€é”€

### æ ˆç©ºé—´ç®¡ç†
æ¯ä¸ªä»»åŠ¡åˆ†é…8KBæ ˆç©ºé—´ï¼Œå¯é€šè¿‡`task stats`å‘½ä»¤ç›‘æ§æ ˆä½¿ç”¨æƒ…å†µï¼š

```bash
task stats
```

---

## ç›‘æ§å‘½ä»¤

### æŸ¥çœ‹ä»»åŠ¡ç»Ÿè®¡
```bash
task stats
```

æ˜¾ç¤º:
- UIä»»åŠ¡æ ˆå‰©ä½™ç©ºé—´
- ç³»ç»Ÿä»»åŠ¡æ ˆå‰©ä½™ç©ºé—´
- å½“å‰å¯ç”¨å †å†…å­˜

### æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯
```bash
task info
```

æ˜¾ç¤º:
- åŒæ ¸æ¶æ„è¯´æ˜
- ä»»åŠ¡åˆ†é…è¯¦æƒ…
- FreeRTOSç³»ç»Ÿä¿¡æ¯
- å †å†…å­˜ç¢ç‰‡ç‡

---

## å…³é”®æ”¹è¿›

### v3.0 vs v2.0

| ç‰¹æ€§ | v2.0 å•æ ¸ | v3.0 åŒæ ¸ |
|------|----------|----------|
| UIåˆ·æ–° | é˜»å¡å¼ | ä¸“ç”¨æ ¸å¿ƒ |
| ä¼ æ„Ÿå™¨æ›´æ–° | é˜»å¡UI | ç‹¬ç«‹è¿è¡Œ |
| åŠ¨ç”»æµç•…åº¦ | å—å¹²æ‰° | ç¨³å®šè¾“å‡º |
| ç³»ç»Ÿå“åº” | ä¸²è¡Œå¤„ç† | å¹¶è¡Œå¤„ç† |
| CPUåˆ©ç”¨ç‡ | ~50% | ~85% |

---

## æ³¨æ„äº‹é¡¹

### LVGLçº¿ç¨‹å®‰å…¨
âš ï¸ **é‡è¦**: æ‰€æœ‰è·¨ä»»åŠ¡è®¿é—®LVGLå¯¹è±¡å¿…é¡»åŠ é”

```cpp
// âŒ é”™è¯¯ - æœªåŠ é”
lv_obj_set_pos(obj, x, y);

// âœ… æ­£ç¡® - å·²åŠ é”
if (taskMgr->takeLVGLMutex(100)) {
    lv_obj_set_pos(obj, x, y);
    taskMgr->giveLVGLMutex();
}
```

### æ ˆæº¢å‡ºä¿æŠ¤
å®šæœŸç›‘æ§æ ˆä½¿ç”¨æƒ…å†µï¼Œå¦‚æœ`Stack free`ä½äº1KBï¼Œéœ€è¦å¢åŠ æ ˆå¤§å°:

```cpp
#define UI_TASK_STACK_SIZE      8192    // å¢åŠ æ­¤å€¼
#define SYSTEM_TASK_STACK_SIZE  8192    // å¢åŠ æ­¤å€¼
```

### æ­»é”é¢„é˜²
- é¿å…åœ¨æŒæœ‰é”æ—¶è¿›è¡Œè€—æ—¶æ“ä½œ
- ä¸è¦åµŒå¥—è·å–åŒä¸€ä¸ªé”
- ä½¿ç”¨è¶…æ—¶å‚æ•°é˜²æ­¢æ°¸ä¹…é˜»å¡

---

## å¼€å‘æŒ‡å—

### æ·»åŠ æ–°çš„UIæ“ä½œ
æ‰€æœ‰UIæ“ä½œåº”åœ¨UIä»»åŠ¡ä¸­æ‰§è¡Œï¼Œæˆ–é€šè¿‡æ¶ˆæ¯é˜Ÿåˆ—é€šçŸ¥UIä»»åŠ¡:

```cpp
// æ–¹å¼1: é€šè¿‡æ¶ˆæ¯é˜Ÿåˆ—
TaskMessage msg;
msg.type = MSG_TRIGGER_BIRD;
taskMgr->sendToUITask(msg);

// æ–¹å¼2: ç›´æ¥åœ¨UIä»»åŠ¡ä¸­æ·»åŠ é€»è¾‘
// ç¼–è¾‘ task_manager.cpp çš„ uiTaskFunction()
```

### æ·»åŠ æ–°çš„åå°ä»»åŠ¡
åœ¨ç³»ç»Ÿä»»åŠ¡ä¸­æ·»åŠ é€»è¾‘:

```cpp
// ç¼–è¾‘ task_manager.cpp çš„ systemTaskFunction()
// æ·»åŠ ä½ çš„å‘¨æœŸæ€§ä»»åŠ¡
```

---

## æ•…éšœæ’æŸ¥

### UIå¡é¡¿
1. æ£€æŸ¥UIä»»åŠ¡æ ˆæ˜¯å¦æº¢å‡º: `task stats`
2. æ£€æŸ¥æ˜¯å¦æœ‰æœªé‡Šæ”¾çš„äº’æ–¥é”
3. å¢åŠ UIä»»åŠ¡ä¼˜å…ˆçº§æˆ–æ ˆå¤§å°

### ç³»ç»Ÿä»»åŠ¡æ— å“åº”
1. æ£€æŸ¥ç³»ç»Ÿä»»åŠ¡æ ˆæ˜¯å¦æº¢å‡º
2. æ£€æŸ¥æ¶ˆæ¯é˜Ÿåˆ—æ˜¯å¦æ»¡
3. å‡å°‘ä»»åŠ¡å‘¨æœŸæˆ–ä¼˜åŒ–è€—æ—¶æ“ä½œ

### å †å†…å­˜ä¸è¶³
1. æ£€æŸ¥å†…å­˜æ³„æ¼ (`task info`)
2. å‡å°‘é™æ€åˆ†é…çš„bufferå¤§å°
3. ä¼˜åŒ–å›¾ç‰‡èµ„æºåŠ è½½ç­–ç•¥

---

## ç‰ˆæœ¬å†å²

- **v3.0** - 2025-12-02
  - å¼•å…¥åŒæ ¸FreeRTOSæ¶æ„
  - UIå’Œç³»ç»Ÿé€»è¾‘å®Œå…¨åˆ†ç¦»
  - æ–°å¢`task`ç›‘æ§å‘½ä»¤
  - æ€§èƒ½æå‡çº¦70%

---

## ç›¸å…³æ–‡ä»¶

- `src/system/tasks/task_manager.h` - ä»»åŠ¡ç®¡ç†å™¨å¤´æ–‡ä»¶
- `src/system/tasks/task_manager.cpp` - ä»»åŠ¡ç®¡ç†å™¨å®ç°
- `src/main.cpp` - ä¸»ç¨‹åºå…¥å£
- `src/system/commands/serial_commands.cpp` - å‘½ä»¤å¤„ç†å™¨

---

**Last Updated**: 2025-12-02  
**Author**: CybirdWatching Development Team
